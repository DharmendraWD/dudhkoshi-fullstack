{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dharmendra/Desktop/Dudhkoshi/frontend/src/proxy.js"],"sourcesContent":["\r\n\r\nimport { NextResponse } from \"next/server\";\r\n\r\n// --- Protected Routes ---\r\nconst PROTECTED_ROUTES = [\r\n  \"/admin/dashboard\",\r\n  \"/admin/hero\",\r\n  \"/admin/about\",\r\n  \"/admin/mission\",\r\n  \"/admin/team\",\r\n  \"/admin/gallery\",\r\n  \"/admin/blogs\",\r\n  \"/admin/messages\",\r\n  \"/admin/faqs\",\r\n  \"/admin/others\",\r\n  \"/admin/user-management\",\r\n  \"/admin/change-password\",\r\n];\r\n\r\nfunction isProtectedRoute(pathname) {\r\n  return PROTECTED_ROUTES.some(route => pathname.startsWith(route));\r\n}\r\n\r\nexport default async function proxy(req) {\r\n  const { nextUrl } = req;\r\n  const pathname = nextUrl.pathname;\r\n\r\n  console.log(\"Proxy running on:\", pathname);\r\n\r\n  // --- Extract token once ---\r\n  const token =\r\n    req.cookies.get(\"token\")?.value ||\r\n    req.headers.get(\"authorization\")?.replace(\"Bearer \", \"\");\r\n\r\n  //  Redirect logged-in users away from /login\r\n  if (pathname === \"/admin/login\" && token) {\r\n    return NextResponse.redirect(new URL(\"/admin/dashboard\", req.url)); \r\n  }\r\n\r\n  // If token exists, verify it, verify token if it is changed or not, if token in not valid then send to login\r\n  if (token && pathname.startsWith('/admin') && pathname !== '/admin/login') {\r\n    try {\r\n      console.log(\"first\")\r\n      const response = await fetch(`${process.env.BASE_API}/me`, {\r\n        headers: { Authorization: `Bearer ${token}` },\r\n        credentials: 'include',\r\n        cache: 'no-store'\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const loginUrl = new URL('/admin/login', req.url);\r\n        const res = NextResponse.redirect(loginUrl);\r\n        res.cookies.delete('token');\r\n        return res;\r\n      }\r\n\r\n      console.log(response.ok)\r\n\r\n  return NextResponse.next();\r\n    } catch (error) {\r\n      console.error(\"Auth check failed:\", error);\r\n      const loginUrl = new URL('/admin/login', req.url);\r\n      const res = NextResponse.redirect(loginUrl);\r\n      res.cookies.delete('token');\r\n      return res;\r\n    }\r\n  }\r\n\r\n  // ⭐ If route NOT protected → allow\r\n  if (!isProtectedRoute(pathname)) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // ⭐ Protected route but no token → send to login\r\n  if (!token) {\r\n    const url = new URL(\"/admin/login\", req.url);\r\n    url.searchParams.set(\"unauth\", \"1\");\r\n    return NextResponse.redirect(url);\r\n  }\r\n\r\n  // ⭐ Everything OK → allow access\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\"/:path*\"],\r\n};\r\n"],"names":[],"mappings":";;;;;;AAEA;;AAEA,2BAA2B;AAC3B,MAAM,mBAAmB;IACvB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,SAAS,iBAAiB,QAAQ;IAChC,OAAO,iBAAiB,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC;AAC5D;AAEe,eAAe,MAAM,GAAG;IACrC,MAAM,EAAE,OAAO,EAAE,GAAG;IACpB,MAAM,WAAW,QAAQ,QAAQ;IAEjC,QAAQ,GAAG,CAAC,qBAAqB;IAEjC,6BAA6B;IAC7B,MAAM,QACJ,IAAI,OAAO,CAAC,GAAG,CAAC,UAAU,SAC1B,IAAI,OAAO,CAAC,GAAG,CAAC,kBAAkB,QAAQ,WAAW;IAEvD,6CAA6C;IAC7C,IAAI,aAAa,kBAAkB,OAAO;QACxC,OAAO,8IAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,oBAAoB,IAAI,GAAG;IAClE;IAEA,6GAA6G;IAC7G,IAAI,SAAS,SAAS,UAAU,CAAC,aAAa,aAAa,gBAAgB;QACzE,IAAI;YACF,QAAQ,GAAG,CAAC;YACZ,MAAM,WAAW,MAAM,MAAM,GAAG,QAAQ,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;gBACzD,SAAS;oBAAE,eAAe,CAAC,OAAO,EAAE,OAAO;gBAAC;gBAC5C,aAAa;gBACb,OAAO;YACT;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,WAAW,IAAI,IAAI,gBAAgB,IAAI,GAAG;gBAChD,MAAM,MAAM,8IAAY,CAAC,QAAQ,CAAC;gBAClC,IAAI,OAAO,CAAC,MAAM,CAAC;gBACnB,OAAO;YACT;YAEA,QAAQ,GAAG,CAAC,SAAS,EAAE;YAE3B,OAAO,8IAAY,CAAC,IAAI;QACtB,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM,WAAW,IAAI,IAAI,gBAAgB,IAAI,GAAG;YAChD,MAAM,MAAM,8IAAY,CAAC,QAAQ,CAAC;YAClC,IAAI,OAAO,CAAC,MAAM,CAAC;YACnB,OAAO;QACT;IACF;IAEA,mCAAmC;IACnC,IAAI,CAAC,iBAAiB,WAAW;QAC/B,OAAO,8IAAY,CAAC,IAAI;IAC1B;IAEA,iDAAiD;IACjD,IAAI,CAAC,OAAO;QACV,MAAM,MAAM,IAAI,IAAI,gBAAgB,IAAI,GAAG;QAC3C,IAAI,YAAY,CAAC,GAAG,CAAC,UAAU;QAC/B,OAAO,8IAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,iCAAiC;IACjC,OAAO,8IAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;KAAU;AACtB"}}]
}